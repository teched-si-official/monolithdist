let r=null;chrome.storage.local.get(["settings"],t=>{const s=t.settings||{autoSave:!1,autoSaveInterval:30};s.autoSave&&l(s.autoSaveInterval)});chrome.storage.onChanged.addListener(t=>{if(t.settings){const s=t.settings.newValue;r!==null&&(clearInterval(r),r=null),s.autoSave&&l(s.autoSaveInterval)}});function l(t){r=setInterval(()=>{c("Auto-saved Session")},t*60*1e3)}async function c(t){const n=(await chrome.tabs.query({currentWindow:!0})).filter(a=>a.url&&!a.url.startsWith("chrome://")).map(a=>({url:a.url,title:a.title||"Untitled",favIconUrl:a.favIconUrl})),e={id:`${Date.now()}-${Math.random().toString(36).substr(2,9)}`,name:t,tabs:n,createdAt:Date.now(),tabCount:n.length};chrome.storage.local.get(["sessions"],a=>{const o=a.sessions||[];o.unshift(e),o.length>50&&o.splice(50),chrome.storage.local.set({sessions:o})})}chrome.runtime.onMessage.addListener((t,s,n)=>{if(t.action==="closeDuplicateTabs")return u().then(e=>n({count:e})),!0;if(t.action==="suspendUnusedTabs")return d().then(e=>n({count:e})),!0});async function u(){const t=await chrome.tabs.query({currentWindow:!0}),s=new Map,n=[];return t.forEach(e=>{e.url&&e.id&&(s.has(e.url)?n.push(e.id):s.set(e.url,e.id))}),n.length>0&&await chrome.tabs.remove(n),n.length}async function d(){const s=(await chrome.tabs.query({currentWindow:!0})).filter(e=>e.id&&!e.active&&!e.pinned&&e.url&&!e.url.startsWith("chrome://")),n=s.map(e=>({url:e.url,title:e.title||"Untitled",favIconUrl:e.favIconUrl}));if(n.length>0){const e={id:`suspended-${Date.now()}`,name:"Suspended Tabs",tabs:n,createdAt:Date.now(),tabCount:n.length};chrome.storage.local.get(["sessions"],o=>{const i=o.sessions||[];i.unshift(e),chrome.storage.local.set({sessions:i})});const a=s.map(o=>o.id);await chrome.tabs.remove(a)}return s.length}
